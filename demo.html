<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>Three.js demo - text array WebGL render</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<style type="text/css">
			body {
				padding: 0;
				margin: 0;
				overflow: hidden;
			}
			#elleSource, #canvasContainer canvas {
				border: none;
				padding: 0;
				margin: 0;
				width: 100%;
				height: 100%;
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
			}
			#canvasContainer canvas {
				z-index: 2;
			}
		</style>

	</head>
	<body>
	
		<iframe id="elleSource" src="http://www.elle.ru/celebrities/znamenitosti-kotoryie-proslavilis-sluchayno/"></iframe>
		<div id="canvasContainer"></div>

		<script src="./demo_assets/three.min.js"></script>
		<script src="./demo_assets/comfortaa.js"></script>
		<script>

			//
			var arrayOfStrings, camera, scene, renderer, group;

			// Запуск демки
			function start(){

				// Получаем текст статьи и ...
				var articleTags = document.getElementById('elleSource').contentWindow.document.getElementsByClassName('j-text')[0].childNodes;
				var articleText = '';
				[].forEach.call(articleTags, function(item) {
					articleText += item.textContent;
				});

				// преобразуем его в массив слов
				arrayOfStrings = articleText.split(/ /);

				// Инициализируем Three.js и запускаем анимацию
				init();
				animate();
			}

			// Инициализация Three.js
			function init() {

				// Камера с перспективной проекцией
				camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 0, 150, 500 );

				// Пустая сцена
				scene = new THREE.Scene();

				// Группа для текстовых элементов (объектов)
				group = new THREE.Group();

				// Создаём текстовый элемент
				function createText (theText, offset) {

					// Геометрия
					var text3d = new THREE.TextGeometry( theText, {
						size: 20,
						height: 5,
						curveSegments: 2,
						font: "comfortaa"
					});

					// Материал
					var textMaterial = new THREE.MeshBasicMaterial( { color: 0x000000, overdraw: 0.5 } );

					// Меш
					var text = new THREE.Mesh( text3d, textMaterial );

					// Положение и ориентация в пространстве
					text.position.x = Math.random() * -100;
					text.position.y = Math.random() * 100;
					text.position.z = -group.position.z - offset;
					text.rotation.x = 0;
					text.rotation.y = Math.PI * 2;

					// Возвращаем готовый текстовый элемент
					return text;
				}

				// Последовательно создаём и добавляем каждый текстовый элемент в группу с небольшим смещением относительно предыдущего элемента
				var offset = 0;
				arrayOfStrings.forEach(function(item, index){
					// Отбрасываем пустые элементы
					if (item != '' && item != ' ' && index < 30) {
						offset += 150;
						var textInstance = createText (item, offset);
						group.add(textInstance);
					}
				});				

				// Добавляем получившуюся группу на сцену
				scene.add( group );

				// WebGL рендер со сглаживанием и прозрачностью
				renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
				renderer.setClearColor( 0x000000, 0 );
				
				// Соотношение сторон и размеры окна рендера
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				// Добавляем окно рендера на страницу
				document.getElementById('canvasContainer').appendChild( renderer.domElement );
			}

			// Запускаем покадровую анимацию
			function animate() {
				requestAnimationFrame( animate );
				render();
			}

			// Каждый кадр сдвигаем группу и обновляем окно рендера
			function render() {
				if (group.position.z < 1500) {
					group.position.z += 5;
					renderer.render( scene, camera );
				}			
			}

		</script>

	</body>
</html>
